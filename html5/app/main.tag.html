<main>
    <h1 class="title">Main Page</h1>
    <div class="subtitle">Hello {user}</div>

    <div class="tags has-addons">
        <span class="tag is-large is-dark">UUID</span>
        <span class="tag is-large is-uuid">{uuid}</span>
        <span class="tag is-large control">
            <a onclick="{getUuid}" class="icon is-medium has-quarter-spin">
                <i class="fa fa-refresh"></i>
            </a>
        </span>
    </div>

    <div if="{appServerColor}" class="tags">
        <span class="tag is-large is-bold bg-{appServerColor}">Application Server</span>
        <span class="tag is-small"></span>
        <span class="tag is-large is-bold bg-{dbServerColor}">Database Server</span>
    </div>

    <div if="{justMarried}" class="is-size-6 msg msg-good fade-in-out">
        Authenticated
        <a onclick="{hideAllMessages}" class="delete is-small msg-good-close"></a>
    </div>

    <style>
        a {
            color: #363636;
        }

        a:hover {
            color: #8C19B3;
            text-decoration: none;
        }

        .is-uuid {
            font-family: monospace;
            font-weight: bold;
            text-transform: uppercase;
        }

        .has-quarter-spin {
            transition: transform 0.2s;
        }

        .has-quarter-spin:hover {
            transform: rotate(45deg);
        }

        .bg-LightSeaGreen {
            background: lightseagreen;
        }

        .bg-Crimson {
            background: crimson;
        }

        .bg-Gold {
            background: gold;
        }

        .bg-RoyalBlue {
            background: royalblue;
        }

        .bg-LightSalmon {
            background: lightsalmon;
        }

        .bg-Black {
            background: black;
        }
    </style>

    <script>
        var self = this
        this.mixin(ObservableMixin)
        this.user = sessionStorage.getItem("user")
        this.ctoken = sessionStorage.getItem("ctoken")
        this.justMarried = false
        this.uuid = ""
        this.appServerColor = false
        this.dbServerColor = false

        this.observable.on(JUST_MARRIED, function (opts) {
            self.justMarried = true
            self.update()
            setTimeout(function () {
                self.justMarried = false
                self.update()
            }, 5000)
        })

        this.on('mount', function () {
            console.log("Loading User Data for " + self.user)
        })

        this.hideAllMessages = () => {
            this.justMarried = false
            this.update()
        }

        this.logout = (event) => {
            event.preventDefault()
            qwest.delete(config.urlEndSession, {
            })
                .then(function (xhr, response) {
                    console.log("Logged out.")
                })
                .catch(function (error, xhr, response) {
                    console.log("Error logging out: " + error)
                })
        }

        this.getUuid = (event) => {
            event.preventDefault()
            self.observable.trigger(LOADING_IN_PROGRESS)
            qwest.get(config.urlUuid, {}, {
                timeout: 5000,
                headers: {
                    "C-Token": self.ctoken
                }
            })
                .then(function (xhr, response) {
                    self.observable.trigger(LOADING_DONE)
                    self.uuid = JSON.parse(xhr.responseText).uuids[0]
                    self.appServerColor = xhr.getResponseHeader("AppServer")
                    self.dbServerColor = xhr.getResponseHeader("DbServer")
                    self.update()
                })
                .catch(function (error, xhr, response) {
                    self.observable.trigger(LOADING_DONE)
                    if (xhr.status === 401) self.observable.trigger(AUTH_FAILED)
                    else self.observable.trigger(AUTH_ERROR, { status: xhr.status, response: xhr.responseText })
                })
            console.log("Sent AJAX request to " + config.urlUuid)
        }
    </script>
</main>