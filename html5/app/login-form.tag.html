<login-form>
    <div class="login">
        <h1>Member Authentication</h1>
        <form onsubmit="{handleLogin}">
            <div class="field">
                <p class="control has-icons-left">
                    <input name="user" ref="user" type="text" value="" placeholder="Username or Email" required>
                    <span class="icon is-left"><i class="fa fa-user fa-fw"></i></span>
                </p>
            </div>
            <div class="field">
                <p class="control has-icons-left">
                    <input ref="password" type="password" value="" placeholder="Password" required>
                    <span class="icon is-left"><i class="fa fa-lock fa-fw"></i></span>
                </p>
            </div>
            <div class="field">
                <p class="is-justified-left-and-right">
                    <span>Not a member yet? <a onclick="{parent.flipCard}" class="fliplink">Join us!</a></span>
                    <span><button type="submit">Sign in</button></span>
                </p>
            </div>
        </form>
    </div>
    <div if="{authFailed}" class="is-size-6 msg msg-bad">
        Authentication failed
        <a onclick="{hideAllMessages}" class="delete is-small msg-bad-close"></a>
    </div>
    <div if="{authSuccess}" class="is-size-6 msg msg-good fade-in-out">
        Authenticated
        <a onclick="{hideAllMessages}" class="delete is-small msg-good-close"></a>
    </div>
    <div if="{authError}" class="is-size-6 msg msg-bad">
        Unexpected Error - please try again later.
        <a onclick="{hideAllMessages}" class="delete is-small msg-bad-close"></a>
    </div>
    <div ref="spinner" if="{isLoading}" class="large-loader hidden"></div>

    <script>
        this.mixin(ObservableMixin)
        var self = this
        this.authFailed = false
        this.authSuccess = false
        this.authError = false
        this.isLoading = false

        this.hideAllMessages = () => {
            this.authFailed = false
            this.authSuccess = false
            this.authError = false
        }

        this.on('mount', () => {
            this.refs.user.focus()
        })
        this.observable.on(AUTH_SUCCESS, function (opts) {
            console.log(AUTH_SUCCESS + ": " + opts.user)
            self.isLoading = false
            self.authSuccess = true
            self.update()
            setTimeout(function() {
                self.authSuccess = false
            }, 5000)
            router.navigate("/main.html");
        })
        this.observable.on(AUTH_FAILED, function () {
            self.isLoading = false
            shakeElement(self.opts.shake)
            self.authFailed = true
            self.update()
        })
        this.observable.on(AUTH_ERROR, function (opts) {
            console.log(AUTH_ERROR + ": " + opts.status + " " + opts.response)
            self.isLoading = false
            self.authError = true
            self.update()
        })

        function createAuthorizationHeader(user, password) {
            var tok = user + ':' + password;
            var hash = btoa(tok);
            return "Basic " + hash;
        }

        this.handleLogin = (event) => {
            event.preventDefault()
            this.hideAllMessages()
            self.isLoading = true
            this.update()
            setTimeout(function() {
                if (self.isLoading) self.refs.spinner.classList.remove("hidden")
            }, 2000)
            var user = this.refs.user.value
            var authHeader = createAuthorizationHeader(user, this.refs.password.value)
            qwest.get(config.urlNewSession, null, {
                headers: {
                    "Authorization": authHeader
                }
            })
                .then(function (xhr, response) {
                    self.observable.trigger(AUTH_SUCCESS, { user: user })
                })
                .catch(function (e, xhr, response) {
                    if (xhr.status === 401) self.observable.trigger(AUTH_FAILED)
                    else self.observable.trigger(AUTH_ERROR, { status: xhr.status, response: xhr.responseText })
                })
            console.log("Sent AJAX request to " + config.urlNewSession)
        }
    </script>

</login-form>