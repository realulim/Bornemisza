<main>

    <div class="centered-column tags has-addons">
        <span class="tag is-large is-dark">UUID</span>
        <span class="tag is-large is-uuid" style="padding-right: 0px;">{uuid}</span>
        <span class="tag is-large control" style="padding-left: 18px;">
            <a onclick="{getUuid}" class="icon is-small has-quarter-spin">
                <i class="fa fa-refresh"></i>
            </a>
        </span>
    </div>

    <div class="centered-column tags has-addons">
        <div if="{appServerColor}" class="tags">
            <span class="tag is-large is-bold bg-{appServerColor}">Application Server</span>
            <span class="tag is-medium is-bold is-uuid">{uuidCount}</span>
            <span class="tag is-large is-bold bg-{dbServerColor}">Database Server</span>
        </div>
    </div>

    <div if="{justMarried}" class="is-size-5 msg msg-good fade-in-out">
        Authenticated
        <a onclick="{hideAllMessages}" class="delete is-small msg-good-close"></a>
    </div>
    <div if="{loadingError}" class="is-size-5 msg msg-bad">
        Unexpected Error - please try again later.
        <a onclick="{hideAllMessages}" class="delete is-small msg-bad-close"></a>
    </div>

    <style>
        .centered-column {
            display: flex;
            justify-content: center;
        }

        .centered-column:last-child {
            margin-bottom: 40px;
        }

        a {
            color: var(--dark);
        }

        a:hover {
            color: var(--purple);
            text-decoration: none;
        }

        .is-uuid {
            font-family: monospace;
            font-weight: bold;
            text-transform: uppercase;
        }

        .has-quarter-spin {
            transition: transform 0.2s;
        }

        .has-quarter-spin:hover {
            transform: rotate(45deg);
        }

        .bg-LightSeaGreen {
            background: lightseagreen;
        }

        .bg-Crimson {
            background: crimson;
        }

        .bg-Gold {
            background: gold;
        }

        .bg-RoyalBlue {
            background: royalblue;
        }

        .bg-LightSalmon {
            background: lightsalmon;
        }

        .bg-Black {
            background: black;
        }
    </style>

    <script>
        this.ctoken = sessionStorage.getItem("ctoken")
        if (this.ctoken == null) router.navigate("/index.html");

        var self = this
        this.mixin(ObservableMixin)
        this.loadingError = false
        this.justMarried = false
        this.uuid = ""
        this.uuidCount = 0
        this.appServerColor = false
        this.dbServerColor = false
        this.singleMode = true
        this.loopMode = false
        this.batchMode = false
        this.worker = null

        // manage charts
        this.chartCounter = 0

        this.observable.on(JUST_MARRIED, function (opts) {
            self.justMarried = true
            self.update()
            setTimeout(function () {
                self.justMarried = false
                self.update()
            }, 5000)
        })
        this.observable.on(LOADING_ERROR, function (opts) {
            console.log(LOADING_ERROR + ": " + opts.error)
            self.loadingError = true
            self.update()
        })

        this.observable.on(START_SINGLE, function () {
            self.singleMode = true
        })
        this.observable.on(STOP_SINGLE, function () {
            self.singleMode = false
        })
        this.observable.on(START_LOOP, function () {
            self.loopMode = true
        })
        this.observable.on(STOP_LOOP, function () {
            self.loopMode = false
        })
        this.observable.on(START_BATCH, function () {
            self.batchMode = true
        })
        this.observable.on(STOP_BATCH, function () {
            self.batchMode = false
        })

        this.hideAllMessages = () => {
            this.justMarried = false
            this.loadingError = false
            this.update()
        }

        this.logout = (event) => {
            event.preventDefault()
            qwest.delete(config.urlEndSession, {
            })
                .then(function (xhr, response) {
                    console.log("Logged out.")
                })
                .catch(function (error, xhr, response) {
                    console.log("Error logging out: " + error)
                })
        }

        this.getUuid = (event) => {
            event.preventDefault()
            if (self.singleMode) {
                makeSingleRequest()
            }
            else if (self.batchMode) {
                startBatchRequests()
            }
            else if (self.loopMode) {
                if (self.worker == null) {
                    self.worker = new Worker("/js/getUuidWorker.js")
                    startLoopRequests()
                }
                else {
                    self.worker.terminate()
                    self.worker = null
                }
            }
            else {
                console.log("Unknown Mode...")
            }
        }

        function makeSingleRequest() {
            self.observable.trigger(LOADING_IN_PROGRESS)
            self.worker = new Worker("/js/getUuidWorker.js")
            self.worker.postMessage(self.ctoken)
            self.worker.onmessage = function (event) {
                self.observable.trigger(LOADING_DONE)
                if (event.data.error) {
                    self.observable.trigger(LOADING_ERROR, { error: event.data.error })
                }
                else {
                    gatherResults(event)
                    self.update()
                }
                self.worker.terminate()
                self.worker = null
            }
        }

        function startLoopRequests() {
            self.worker.postMessage(self.ctoken)
            self.worker.onmessage = function (event) {
                if (event.data.error) {
                    console.log("Error: " + event.data.error)
                }
                else {
                    gatherResults(event)
                    self.update()
                }
                if (self.loopMode) {
                    // Still in loop mode? Get another UUID.
                    self.worker.postMessage(self.ctoken)
                }
            }
        }

        function startBatchRequests() {
            var uuidStart = self.uuidCount
            var batchSize = 1000
            self.worker = new Worker("/js/getUuidWorker.js")
            for (var i = 0; i < batchSize; i++) {
                self.worker.postMessage(self.ctoken)
            }
            self.worker.onmessage = function (event) {
                if (event.data.error) {
                    console.log("Error: " + event.data.error)
                    batchSize--
                }
                else {
                    gatherResults(event)
                }
                if ((self.uuidCount - uuidStart) >= batchSize) {
                    // Only update the screen after the batch is complete
                    self.update()
                    self.worker.terminate()
                    self.worker = null
                }
            }
        }

        function gatherResults(event) {
            self.uuid = event.data.uuid
            self.appServerColor = event.data.appServerColor
            self.dbServerColor = event.data.dbServerColor
            self.uuidCount++
            self.chartCounter++
            if (self.chartCounter > 10) {
                // redraw chart every 10th request
                self.chartCounter = 0
                self.observable.trigger(UPDATE_APPSERVERS_CHART, { data: appServerData })
            }
        }

        var appServerData = {
            labels: ["110", "0", "10", "0", "0"],
            series: [[110], [0], [10], [0], [0]]
        }

    </script>
</main>